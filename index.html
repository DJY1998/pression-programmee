<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Programmiertes Lernen ‚Äì Druck</title>

  <!-- F√ºr Formeln im LaTeX-√§hnlichen Markdown: $p = \frac{F}{A}$ -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <style>
    :root {
      --bg: #050810;
      --bg-card: #0f172a;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.18);
      --danger: #f97373;
      --success: #4ade80;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.55);
      --radius-xl: 1.25rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", Arial, sans-serif;
      background: #0b1220;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .app {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(260px, 1.4fr);
      gap: 24px;
      max-width: 1200px;
      width: 100%;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #0e1728;
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      padding: 22px 24px 20px;
      position: relative;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 12px;
    }

    .title-main {
      font-size: 1.35rem;
      font-weight: 650;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.85);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .objectifs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .objectif-chip {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .objectif-chip span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .progress-wrapper {
      margin-bottom: 16px;
    }

    .progress-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .progress-bar-bg {
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.9);
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #4ade80);
      transition: width 0.35s ease-out;
    }

    .steps-container {
      margin-top: 8px;
      min-height: 260px;
    }

    .step {
      display: none;
      animation: fadeIn 0.35s ease-out;
    }

    .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .step-tag {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-tag::before {
      content: "";
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle, var(--accent) 0, transparent 70%);
      border: 1px solid rgba(34, 211, 238, 0.4);
    }

    .step-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .step-instruction {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .reading-box {
      border-radius: 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.5);
      padding: 10px 12px;
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .reading-box strong {
      color: var(--text);
    }

    .formula-box {
      border-radius: 0.9rem;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(15, 23, 42, 0.55);
      padding: 10px 12px;
      font-size: 0.88rem;
      margin-bottom: 12px;
    }

    .formula-box .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .formula-box .math {
      font-size: 0.96rem;
      margin-bottom: 4px;
    }

    .formula-box .explain {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .reading-guard {
      border-radius: 0.9rem;
      border: 1px solid rgba(56, 189, 248, 0.5);
      background: rgba(34, 211, 238, 0.08);
      padding: 10px 12px;
      margin: 10px 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .reading-guard.done {
      border-color: rgba(74, 222, 128, 0.6);
      background: rgba(34, 197, 94, 0.08);
      color: var(--text);
    }

    .reading-guard button {
      margin-top: 8px;
    }

    .lockable {
      position: relative;
      transition: opacity 0.2s ease;
    }

    .lockable.locked {
      opacity: 0.55;
      pointer-events: none;
    }

    .lockable.locked::after {
      content: "Lies zuerst den angegebenen Abschnitt und best√§tige die Lekt√ºre, um die Fragen freizuschalten.";
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      text-align: center;
      background: rgba(0, 0, 0, 0.45);
      color: var(--text);
      font-size: 0.82rem;
      border-radius: 0.8rem;
    }

    .question {
      margin-top: 6px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .options {
      display: grid;
      gap: 6px;
      margin-bottom: 8px;
    }

    .option-btn {
      width: 100%;
      text-align: left;
      border-radius: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      padding: 10px 12px;
      font-size: 0.9rem;
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.15s ease, background 0.15s ease;
    }

    .option-btn:hover {
      border-color: rgba(56, 189, 248, 0.6);
      background: rgba(15, 23, 42, 0.8);
    }

    .option-btn.correct {
      border-color: rgba(74, 222, 128, 0.9);
      background: rgba(22, 163, 74, 0.18);
    }

    .option-btn.incorrect {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(127, 29, 29, 0.2);
    }

    .feedback {
      font-size: 0.82rem;
      margin-bottom: 8px;
      min-height: 18px;
    }

    .feedback.ok {
      color: var(--success);
    }

    .feedback.ko {
      color: var(--danger);
    }

    .numeric-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .numeric-input-row input {
      flex: 0 0 150px;
      padding: 7px 9px;
      border-radius: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    .numeric-input-row input:focus {
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: none;
    }

    .btn-primary, .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 0.8rem;
      padding: 8px 14px;
      font-size: 0.84rem;
      cursor: pointer;
      border: none;
      outline: none;
      transition: all 0.16s ease-out;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(120deg, var(--accent), #4ade80);
      color: #0b1120;
      font-weight: 600;
      box-shadow: none;
    }

    .btn-primary:hover {
      filter: brightness(1.03);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.95);
      color: var(--muted);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-secondary:hover {
      border-color: rgba(148, 163, 184, 0.9);
      color: var(--text);
    }

    .btn-compact {
      padding: 6px 10px;
      font-size: 0.78rem;
      white-space: nowrap;
      width: auto;
    }

    .btn-meditation {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 14px;
      border-radius: 12px;
      background: linear-gradient(120deg, #fcd34d, #f97316);
      color: #0b1120;
      border: none;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(249, 115, 22, 0.35);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .btn-meditation:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(249, 115, 22, 0.45);
    }

    .hidden-soft {
      display: none !important;
    }

    .reading-hidden {
      display: none !important;
    }

    .reading-toggle {
      margin: 6px 0 10px;
      font-size: 0.8rem;
    }

    /* Modal pour la m√©ditation */
    #meditation-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
      padding: 12px;
    }

    #meditation-modal.visible {
      display: flex;
    }

    .meditation-card {
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 1rem;
      padding: 16px;
      width: min(420px, 94vw);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.55);
    }

    .meditation-card h3 {
      margin-bottom: 8px;
      font-size: 1rem;
      font-weight: 700;
    }

    .meditation-card p {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.45;
      margin-bottom: 12px;
    }

    .meditation-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* Confetti */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 70;
    }

    .actions-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .actions-left, .actions-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 0.75rem;
      color: var(--muted);
    }

    /* Seitenpanel */
    .side-card-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .side-section {
      margin-bottom: 14px;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .side-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0;
    }

    .side-list li {
      padding: 3px 0;
      display: flex;
      align-items: flex-start;
      gap: 6px;
    }

    .side-list li::before {
      content: "‚Ä¢";
      color: var(--accent);
      margin-top: 1px;
    }

    .badge-small {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-left: 4px;
      color: var(--muted);
    }

    .side-note {
      border-radius: 0.9rem;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      padding: 8px 9px;
      font-size: 0.78rem;
      margin-top: 6px;
    }

    .score-box {
      border-radius: 0.9rem;
      border: 1px solid rgba(56, 189, 248, 0.55);
      background: var(--accent-soft);
      padding: 8px 9px;
      font-size: 0.8rem;
      margin-bottom: 10px;
    }

    .score-value {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--accent);
    }

    .score-label {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .question-block {
      display: none;
      animation: fadeIn 0.3s ease-out;
      border: 1px solid rgba(55, 65, 81, 0.7);
      border-radius: 0.9rem;
      padding: 10px 12px;
      margin-bottom: 10px;
      background: rgba(15, 23, 42, 0.8);
    }

    .question-block.active {
      display: block;
    }

    .question-block .question {
      margin-top: 0;
    }

    /* Hint panel */
    #hint-panel {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%) translateY(16px);
      width: 90vw;
      max-width: 420px;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.55);
      padding: 12px 14px;
      color: var(--text);
      display: none;
      gap: 10px;
      z-index: 50;
      flex-direction: column;
    }

    #hint-panel.visible {
      display: flex;
      transform: translateX(-50%) translateY(0);
      transition: transform 0.2s ease-out;
    }

    #hint-panel .hint-title {
      font-weight: 650;
      margin-bottom: 4px;
      color: var(--accent);
    }

    #hint-panel .hint-body {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.45;
    }

    #hint-panel .hint-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    /* Mobile toggles */
    .mobile-toggle-bar {
      display: none;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .mobile-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-size: 0.82rem;
      cursor: pointer;
    }

    @media (max-width: 720px) {
      .mobile-toggle-bar {
        display: flex;
      }
      .collapsed-mobile {
        display: none !important;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
        white-space: normal;
        line-height: 1.3;
        text-align: center;
        padding: 10px 16px;
      }

      .btn-compact {
        width: auto;
        white-space: nowrap;
      }

      .option-btn {
        white-space: normal;
        line-height: 1.35;
        padding: 10px 12px;
      }

      .actions-row {
        flex-direction: column;
        align-items: stretch;
      }

      .actions-left,
      .actions-right {
        width: 100%;
        justify-content: stretch;
      }
    }

    /* Reward image */
    #reward-badge {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 320px;
      height: 320px;
      border-radius: 1.4rem;
      border: 1px solid rgba(56, 189, 248, 0.45);
      background: rgba(15, 23, 42, 0.92);
      box-shadow: 0 18px 44px rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      overflow: hidden;
      opacity: 0;
      transform: translate(-50%, -40%);
      transition: all 0.25s ease-out;
      pointer-events: none;
      z-index: 40;
    }

    #reward-badge.visible {
      opacity: 1;
      transform: translate(-50%, -50%);
    }

    #reward-badge img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.92);
    }

    #reward-message {
      position: relative;
      width: 100%;
      padding: 10px 12px;
      text-align: center;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.78) 35%);
      color: #f8fafc;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.55);
      font-size: 1.05rem;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Hauptspalte: programmierte Sequenz -->
    <main class="card">
      <div class="mobile-toggle-bar">
        <button class="mobile-toggle" onclick="toggleMobileSection('header-info', this, 'Infos anzeigen', 'Infos ausblenden')">
          Infos anzeigen
        </button>
        <button class="mobile-toggle" onclick="toggleMobileSection('side-panel', this, 'Formeln/Memo anzeigen', 'Formeln/Memo ausblenden')">
          Formeln/Memo anzeigen
        </button>
      </div>

      <div class="header collapsed-mobile" id="header-info">
        <div>
          <div class="title-main">Druck ‚Äì Gef√ºhrter Parcours ¬∑ Klasse 212</div>
          <p class="subtitle" id="subtitle-text">
            Arbeite in deinem Tempo. Lies die Hinweise, schlage im Arbeitsheft nach
            und beantworte die Fragen. Bei einer richtigen Antwort geht es weiter;
            bei einem Fehler gibt es eine kurze Hilfe, bevor du fortf√§hrst.
          </p>
        </div>
        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <div class="pill">Programmiertes Lernen</div>
          <button class="btn-meditation" onclick="openMeditation()">üò™ Ich bin m√ºde</button>
          <button class="btn-secondary btn-compact" id="reset-btn" onclick="resetProgress()">Reset Fortschritt</button>
        </div>
      </div>

      <div class="objectifs" id="capsules-row">
        <div class="objectif-chip">
          <span></span> Druck als $p = \dfrac{F}{A}$
        </div>
        <div class="objectif-chip">
          <span></span> Einheiten: Pa, bar, mmHg
        </div>
        <div class="objectif-chip">
          <span></span> Hydrostatik $p = p_0 + \rho g h$
        </div>
        <div class="objectif-chip">
          <span></span> Einfache Anwendungen (Wasser, Hg)
        </div>
      </div>

      <div class="progress-wrapper">
      <div class="progress-label-row">
        <div>Fortschritt</div>
        <div id="progress-text">0 / 9 Schritte best√§tigt</div>
      </div>
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="progress-bar"></div>
        </div>
      </div>

      <div class="steps-container">
        <!-- Schritt 0: Intro -->
        <section class="step active" id="step-intro" data-index="0">
          <div class="step-tag">Startpunkt</div>
          <h2 class="step-title">Wie funktioniert dieser Parcours?</h2>
          <p class="step-instruction">
            Du kommst vielleicht aus einer langen Arbeitsphase ‚Äì hier sollst du ruhig und selbst√§ndig arbeiten k√∂nnen.
            Du kannst jederzeit zur√ºckspringen.
          </p>
          <div class="reading-box">
            <strong>Ben√∂tigtes Material</strong><br />
            ‚Ä¢ Dein Arbeitsheft <em>¬´ Temperatur ‚Äì W√§rme ¬ª</em>, Abschnitte <strong>Druck</strong> und
            <strong>Druck in einer ruhenden Fl√ºssigkeit</strong> (Teil zum Torricelli-Barometer).<br />
            ‚Ä¢ Dein Taschenrechner.<br />
            ‚Ä¢ Etwas zum Notieren (Schmierblatt).
          </div>
          <p class="step-instruction">
            Du gehst in kleinen Schritten vor. Nach jeder Antwort bekommst du sofort R√ºckmeldung.
            Bei einem Fehler gibt es einen kurzen Hilfeschritt (verzweigtes programmiertes Lernen).
          </p>
          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="goToStep('step-pretest')">
                Parcours starten
              </button>
            </div>
            <div class="actions-right">
              <span class="hint">Zwischen zwei Schritten kannst du jederzeit pausieren.</span>
            </div>
          </div>
        </section>

        <!-- Schritt 1: Diagnose -->
        <section class="step" id="step-pretest" data-index="1">
          <div class="step-tag">Schritt 1 ¬∑ Diagnose</div>
          <h2 class="step-title">Druck oder Kraft?</h2>
          <div class="reading-box">
            √ñffne dein Arbeitsheft, Abschnitt <strong>¬´ Druck ¬ª</strong> (Definition) und lies den ersten Absatz,
            der $p = \dfrac{F}{A}$ erl√§utert. Notiere die Formel auf deinem Schmierblatt und
            best√§tige die Lekt√ºre unten.
          </div>
          <div class="reading-guard" data-step-guard="step-pretest">
            <div>Hast du den Abschnitt ¬´ Druck ¬ª gelesen, bevor du antwortest?</div>
            <button class="btn-primary" onclick="unlockStep('step-pretest')">
              Abschnitt gelesen ‚Üí Frage freischalten
            </button>
          </div>

          <div class="lockable" data-step-lock="step-pretest">
            <p class="question">
              Ein Block von $100\,\text{N}$ liegt auf<br />
              (A) einem Tisch mit Fl√§che $1.0\,\text{m}^2$<br />
              (B) demselben Tisch, aber auf einer Platte mit $0.10\,\text{m}^2$.<br /><br />
              In welchem Fall ist der <strong>Druck</strong> auf den Tisch gr√∂√üer?
            </p>
            <div class="options">
              <button class="option-btn" data-correct="false" onclick="handleMCQ(this, 'pretest', false)">
                In Fall (A), weil die Kraft gleich bleibt.
              </button>
              <button class="option-btn" data-correct="true" onclick="handleMCQ(this, 'pretest', true)">
                In Fall (B), weil die gleiche Kraft auf eine kleinere Fl√§che wirkt.
              </button>
              <button class="option-btn" data-correct="false" onclick="handleMCQ(this, 'pretest', false)">
                Der Druck ist in (A) und (B) identisch.
              </button>
            </div>
            <div id="feedback-pretest" class="feedback"></div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-secondary" onclick="goToStep('step-intro')">‚Üê Zur√ºck</button>
            </div>
            <div class="actions-right">
              <span class="hint">
                Bei einem Fehler folgt eine kurze Erkl√§rung, bevor es weitergeht.
              </span>
            </div>
          </div>
        </section>

        <!-- Schritt 1b: Remedial Druck -->
        <section class="step" id="step-remediation-pression" data-index="1">
          <div class="step-tag">Schritt 1 bis ¬∑ Gezielte Hilfe</div>
          <h2 class="step-title">Definition von Druck wiederholen</h2>
          <div class="reading-box">
            <strong>Im Arbeitsheft nachlesen</strong><br />
            1. Finde den Abschnitt <strong>¬´ Druck ¬ª</strong> (S. 8) und lies den ersten Absatz, der den Druck als Verh√§ltnis von Kraft und Fl√§che beschreibt (Beispiel Ballon / Reifen).<br />
            2. Notiere auf deinem Schmierblatt die Definition auf Deutsch:<br />
            <em>¬´ Druck ist die senkrechte Kraft pro Fl√§cheneinheit. ¬ª</em>
          </div>
          <div class="formula-box">
            <div class="label">Merkformel (selbst aufschreiben)</div>
            <div class="math">
              $p = \dfrac{F}{A}$
            </div>
            <div class="explain">
              $p$ in Pascal (Pa), $F$ in Newton (N), $A$ in m$^2$.
            </div>
          </div>
          <p class="step-instruction">
            Denk noch einmal an den Tisch: Wenn die Fl√§che $A$ kleiner wird, die Kraft $F$ aber gleich bleibt ‚Äì was passiert mit dem Quotienten $F/A$?
          </p>
          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="goToStep('step-pretest')">
                Diagnosefrage erneut l√∂sen
              </button>
            </div>
            <div class="actions-right">
              <span class="hint">Bei richtiger Antwort geht es weiter.</span>
        </div>
      </div>
    </section>

        <!-- Schritt 1c: Remedial Einheiten -->
        <section class="step" id="step-remediation-unites" data-index="2">
          <div class="step-tag">Schritt 2 bis ¬∑ Gezielte Hilfe</div>
          <h2 class="step-title">Druckeinheiten wiederholen</h2>
          <div class="reading-box">
            <strong>Zu behalten</strong><br />
            $1\,\text{bar} = 1.0 \times 10^5\,\text{Pa}$<br />
            $1\,\text{atm} \approx 1.013 \times 10^5\,\text{Pa}$<br />
            $760\,\text{mmHg} \approx 1\,\text{atm} \approx 1.0\,\text{bar}$<br />
            $1\,\text{mmHg} \approx 133.3\,\text{Pa}$
          </div>
          <p class="step-instruction">
            Rechne zum Vergleichen immer in Pascal oder bar um. Beispiel: $1.0\,\text{bar} = 100{\,}000\,\text{Pa}$.
          </p>
          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="goToStep('step-unites')">Frage erneut l√∂sen</button>
            </div>
          </div>
        </section>

        <!-- Schritt 2: Einheiten -->
        <section class="step" id="step-unites" data-index="2">
          <div class="step-tag">Schritt 2 ¬∑ Druckeinheiten</div>
          <h2 class="step-title">Pascal, bar und mmHg</h2>
          <div class="reading-box">
            <strong>Gef√ºhrte Lekt√ºre</strong><br />
            Lies im Arbeitsheft den Teil, in dem die Druckeinheiten eingef√ºhrt werden
            (<strong>¬´ Definition ¬ª und Tabelle der Einheiten</strong>, Abschnitt <em>Druck</em>). Notiere auf deinem Schmierblatt:
            <br />‚Ä¢ $1\,\text{Pa} = 1\,\text{N}/\text{m}^2$<br />
            ‚Ä¢ $1\,\text{bar} = 10^5\,\text{Pa}$<br />
            ‚Ä¢ $1\,\text{mmHg} \approx 133.3\,\text{Pa}$ (Quecksilbers√§ule).
          </div>

          <div class="reading-guard" data-step-guard="step-unites">
            <div>Lies diese Zeilen im Arbeitsheft (Definition + Einheitentabelle) und best√§tige, um die Fragen freizuschalten.</div>
            <button class="btn-primary" onclick="unlockStep('step-unites')">
              Abschnitt gelesen ‚Üí Fragen freischalten
            </button>
          </div>

          <div class="lockable" data-step-lock="step-unites">
            <div class="question-block active" data-mcq-step="step-unites" data-mcq-index="0">
              <p class="question">
                1/2 ¬∑ Der atmosph√§rische Druck betr√§gt etwa $1.0\,\text{bar}$. Welche Angabe in Pascal passt am besten?
              </p>
              <div class="options">
                <button class="option-btn" onclick="handleMCQ(this, 'unites1', false)">
                  $1.0\,\text{Pa}$
                </button>
                <button class="option-btn" onclick="handleMCQ(this, 'unites1', true)">
                  $1.0 \times 10^5\,\text{Pa}$
                </button>
                <button class="option-btn" onclick="handleMCQ(this, 'unites1', false)">
                  $1.0 \times 10^3\,\text{Pa}$
                </button>
              </div>
            </div>

            <div class="question-block" data-mcq-step="step-unites" data-mcq-index="1">
              <p class="question">
                2/2 ¬∑ Auf einem Barometer liest du $760\,\text{mmHg}$. Wozu entspricht das am ehesten?
              </p>
              <div class="options">
                <button class="option-btn" onclick="handleMCQ(this, 'unites2', true)">
                  Etwa dem normalen atmosph√§rischen Druck.
                </button>
                <button class="option-btn" onclick="handleMCQ(this, 'unites2', false)">
                  Beinahe einem perfekten Vakuum.
                </button>
                <button class="option-btn" onclick="handleMCQ(this, 'unites2', false)">
                  $760\,\text{Pa}$, also viel weniger als $1\,\text{bar}$.
                </button>
              </div>
            </div>

            <div id="feedback-unites" class="feedback"></div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-secondary" onclick="goToStep('step-pretest')">‚Üê Vorheriger Schritt</button>
            </div>
            <div class="actions-right">
              <button id="btn-to-hydro" class="btn-primary hidden-soft" onclick="attemptAdvance('step-hydrostatique','step-unites')">
                N√§chster Schritt: Druck in einer Fl√ºssigkeit ‚Üí
              </button>
            </div>
          </div>
        </section>

        <!-- Schritt 3: p = p0 + rho g h -->
        <section class="step" id="step-hydrostatique" data-index="3">
          <div class="step-tag">Schritt 3 ¬∑ Hydrostatik</div>
          <h2 class="step-title">Woher kommt $p = p_0 + \rho g h$?</h2>

          <div class="reading-box">
            <strong>In Ruhe lesen</strong><br />
            1. Lies im Arbeitsheft den Abschnitt
            <strong>¬´ Druck in einer ruhenden Fl√ºssigkeit ¬ª</strong> (Fl√ºssigkeitss√§ule mit Dichte
            $\rho$, H√∂he $h$ und Querschnitt $S$).<br />
            2. Zeichne in dein Heft die S√§ule (oben Druck $p_0$, unten Druck $p$). Beschrifte alle Kr√§fte auf die S√§ule.
          </div>

          <div class="formula-box">
            <div class="label">Herleitung (Kurzfassung)</div>
            <div class="math">
              Gewicht der S√§ule: $F = mg = \rho V g = \rho S h g$<br />
              Druck der S√§ule: $p_{\text{S√§ule}} = \dfrac{F}{S} = \rho g h$<br />
              Gesamtdruck unten: $p = p_0 + \rho g h$
            </div>
            <div class="explain">
              $p_0$: Druck an der Oberfl√§che (oft Atmosph√§rendruck), $h$: Tiefe unter der Oberfl√§che.
            </div>
          </div>

          <div class="reading-guard" data-step-guard="step-hydrostatique">
            <div>Best√§tige, dass du ¬´ Druck in einer ruhenden Fl√ºssigkeit ¬ª gelesen und die Skizze √ºbernommen hast.</div>
            <button class="btn-primary" onclick="unlockStep('step-hydrostatique')">
              Gelesen / skizziert ‚Üí freischalten
            </button>
          </div>

          <div class="lockable" data-step-lock="step-hydrostatique">
            <p class="question">
              Wir sind in einem S√º√üwassersee ($\rho \approx 1000\,\text{kg/m}^3$). Wir tauchen auf $h = 5.0\,\text{m}$
              unter die Oberfl√§che. Die Gesamtdrucktiefe ist n√§her bei ‚Ä¶ (die kleine Differenz zwischen $1.013$ und $1.0$ vernachl√§ssigen).
            </p>

            <div class="options">
              <button class="option-btn" onclick="handleMCQ(this, 'hydro1', false)">
                $p \approx 5.0 \times 10^4\,\text{Pa}$ (nur die Wassers√§ule z√§hlt).
              </button>
              <button class="option-btn" onclick="handleMCQ(this, 'hydro1', true)">
                $p \approx 1.5 \times 10^5\,\text{Pa}$ (Atmosph√§re + Wasser).
              </button>
              <button class="option-btn" onclick="handleMCQ(this, 'hydro1', false)">
                $p \approx 1.0 \times 10^5\,\text{Pa}$ (gleich wie an der Oberfl√§che).
              </button>
            </div>

            <div id="feedback-hydro" class="feedback"></div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-secondary" onclick="goToStep('step-unites')">‚Üê Vorheriger Schritt</button>
            </div>
            <div class="actions-right">
              <button id="btn-to-torricelli" class="btn-primary hidden-soft" onclick="attemptAdvance('step-torricelli','step-hydrostatique')">
                N√§chster Schritt: Quecksilbers√§ule ‚Üí
              </button>
            </div>
          </div>
        </section>

        <!-- Schritt 3b: Remedial Hydro -->
        <section class="step" id="step-remediation-hydro" data-index="3">
          <div class="step-tag">Schritt 3 bis ¬∑ Gezielte Hilfe</div>
          <h2 class="step-title">p0 und die Fl√ºssigkeitss√§ule addieren</h2>
          <div class="reading-box">
            <strong>Erinnerung</strong><br />
            $p = p_0 + \rho g h$<br />
            $p_0$: Druck an der Oberfl√§che (oft $1.0\,\text{bar}$).<br />
            $\rho g h$: Zusatzdruck durch die S√§ule (in Pa).
          </div>
          <p class="step-instruction">
            Berechne immer zuerst $\rho g h$ und addiere dann $p_0$. F√ºr Wasser: $1000 \times 9.81 \times h$ ergibt Pascal.
          </p>
          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="goToStep('step-hydrostatique')">Frage erneut l√∂sen</button>
            </div>
          </div>
        </section>

        <!-- Schritt 4: Torricelli -->
        <section class="step" id="step-torricelli" data-index="4">
          <div class="step-tag">Schritt 4 ¬∑ Quecksilbers√§ule</div>
          <h2 class="step-title">Torricelli und die $\text{mmHg}$</h2>

          <div class="reading-box">
            <strong>Gezielte Lekt√ºre</strong><br />
            Suche im Arbeitsheft den Absatz √ºber das <strong>Torricelli-Barometer</strong> (Quecksilberrohr, das in ein Gef√§√ü getaucht wird). Achte auf:
            <br />
            ‚Ä¢ die H√∂he $h$ der Quecksilbers√§ule,<br />
            ‚Ä¢ das Vakuum √ºber dem Quecksilber,<br />
            ‚Ä¢ den Atmosph√§rendruck auf das Gef√§√ü.
          </div>

          <p class="step-instruction">
            Wir nehmen die Dichte des Quecksilbers als<br />
            $\rho_{\text{Hg}} = 13.6 \times 10^3\,\text{kg/m}^3$ und $g = 9.81\,\text{m/s}^2$.
          </p>

          <div class="reading-guard" data-step-guard="step-torricelli">
            <div>Lies den Absatz zum Torricelli-Barometer und sieh dir die Skizze an, bevor du rechnest.</div>
            <button class="btn-primary" onclick="unlockStep('step-torricelli')">
              Gelesen / betrachtet ‚Üí Rechnung freischalten
            </button>
          </div>

          <div class="lockable" data-step-lock="step-torricelli">
            <p class="question">
              Nutze $p = \rho g h$, um die Quecksilberh√∂he zu finden, die zu
              $p_0 = 1.01 \times 10^5\,\text{Pa}$ geh√∂rt. Gib deine Antwort in mm an.<br /><br />
              (Tipp: Stelle $h$ frei und rechne aus.)
            </p>

            <div class="numeric-input-row">
              <input type="number" id="input-hg" placeholder="H√∂he in mm" />
              <button class="btn-primary" onclick="checkNumeric('hg')">
                Pr√ºfen
              </button>
            </div>
            <div id="feedback-hg" class="feedback"></div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-secondary" onclick="goToStep('step-hydrostatique')">‚Üê Vorheriger Schritt</button>
            </div>
            <div class="actions-right">
          <button id="btn-to-exo-hydro" class="btn-primary hidden-soft" onclick="attemptAdvance('step-exo-hydro','step-torricelli')">
                N√§chster Schritt: √úbungsaufgaben ‚Üí
              </button>
            </div>
          </div>
        </section>

        <!-- Schritt 4b: Remedial Hg -->
        <section class="step" id="step-remediation-hg" data-index="4">
          <div class="step-tag">Schritt 4 bis ¬∑ Gezielte Hilfe</div>
          <h2 class="step-title">Quecksilberh√∂he und Druck</h2>
          <div class="reading-box">
            <strong>Formel</strong><br />
            $p = \rho g h \quad \Rightarrow \quad h = \dfrac{p}{\rho g}$<br />
            Rechne mit $\rho_{\text{Hg}} = 13.6 \times 10^3\,\text{kg/m}^3$ und $g = 9.81$.
            Stelle $h$ frei, rechne in Metern und wandle erst am Ende in Millimeter um.
          </div>
          <p class="step-instruction">
            Pr√ºfe systematisch: Formel umstellen, Einheiten konsistent, erst danach in mm umwandeln.
          </p>
          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="goToStep('step-torricelli')">Frage erneut l√∂sen</button>
            </div>
          </div>
        </section>

        <!-- Schritt 5: einfache Hydro-√úbungen -->
        <section class="step" id="step-exo-hydro" data-index="5">
          <div class="step-tag">Schritt 5 ¬∑ Anwendungen</div>
          <h2 class="step-title">Kleine Hydrostatik-√úbungen</h2>

          <p class="step-instruction">
            F√ºr jede Frage: Skizze machen, Formel $p = p_0 + \rho g h$ und Daten aufschreiben, dann rechnen. Du darfst vern√ºnftig runden.
          </p>

          <div class="reading-guard" data-step-guard="step-exo-hydro">
            <div>Lies im Arbeitsheft die Beispielrechnungen zu $p = p_0 + \rho g h$, bevor du diese zwei Aufgaben machst.</div>
            <button class="btn-primary" onclick="unlockStep('step-exo-hydro')">
              Beispiele gelesen ‚Üí Aufgaben freischalten
            </button>
          </div>

          <div class="lockable" data-step-lock="step-exo-hydro">
            <div class="question-block active" data-question-step="step-exo-hydro" data-question-index="0">
              <p class="question">
                1/2 ¬∑ In welcher Tiefe unter der Wasseroberfl√§che erreicht der Gesamtdruck etwa
                $3.0\,\text{bar}$ (mit $p_0 \approx 1.0\,\text{bar}$)?<br />
                Gib deine Antwort in Metern (grobe Absch√§tzung).
              </p>
              <div class="numeric-input-row">
                <input type="number" id="input-3bar" placeholder="Tiefe in m" />
                <button class="btn-primary" onclick="checkNumeric('3bar')">
                  Pr√ºfen
                </button>
              </div>
              <div id="feedback-3bar" class="feedback"></div>
            </div>

            <div class="question-block" data-question-step="step-exo-hydro" data-question-index="1">
              <p class="question">
                2/2 ¬∑ Ein Wasser-Manometer soll den Atmosph√§rendruck als entsprechende Wasserh√∂he f√ºr $1.0\,\text{atm}$ anzeigen. Wie hoch m√ºsste die Wassers√§ule ungef√§hr sein (in m)?
              </p>

              <div class="numeric-input-row">
                <input type="number" id="input-watercol" placeholder="H√∂he in m" />
                <button class="btn-primary" onclick="checkNumeric('watercol')">
                  Pr√ºfen
                </button>
              </div>

              <div id="feedback-watercol" class="feedback"></div>
            </div>
          </div>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-secondary" onclick="goToStep('step-torricelli')">‚Üê Vorheriger Schritt</button>
            </div>
        <div class="actions-right">
          <button id="btn-to-avance" class="btn-primary hidden-soft" onclick="attemptAdvance('step-exo-avance','step-exo-hydro')">
            N√§chster Schritt: Anwendungssituationen ‚Üí
          </button>
        </div>
      </div>
    </section>
    <!-- Schritt 5b: Remedial √úbungen -->
    <section class="step" id="step-remediation-exo" data-index="5">
      <div class="step-tag">Schritt 5 bis ¬∑ Gezielte Hilfe</div>
      <h2 class="step-title">p = p0 + œÅgh f√ºr Wasser wiederholen</h2>
      <div class="reading-box">
        <strong>Gr√∂√üenordnungen</strong><br />
        In Wasser: $\rho \approx 1000\,\text{kg/m}^3$, also $ \rho g h \approx 10^4 \times h$ in Pa.<br />
        Berechne stets den √úberdruck (ohne $p_0$), teile durch $\rho g$ und konvertiere erst danach in bar/mm.
      </div>
      <p class="step-instruction">
        Berechne zuerst die √úberdruckkomponente ($p - p_0$) und teile dann durch $\rho g$, um $h$ zu finden.
      </p>
      <div class="actions-row">
        <div class="actions-left">
          <button class="btn-primary" onclick="goToStep('step-exo-hydro')">√úbungen erneut l√∂sen</button>
        </div>
      </div>
    </section>

    <!-- Schritt 6: Fortgeschrittene Anwendungen -->
    <section class="step" id="step-exo-avance" data-index="6">
        <div class="step-tag">Schritt 6 ¬∑ Anwendungssituationen</div>
        <h2 class="step-title">Pr√ºfe dein K√∂nnen</h2>

        <p class="step-instruction">
          Zwei Situationen, die Einheiten und Hydrostatik kombinieren. Verwende $p = p_0 + \rho g h$
          mit $g \approx 9.81\,\text{m/s}^2$ und, wenn nicht anders angegeben, $p_0 \approx 1.0\,\text{bar}$.
        </p>

        <div class="reading-guard" data-step-guard="step-exo-avance">
          <div>Lies vorher die Bezugswerte f√ºr Einheiten (bar ‚Üî Pa ‚Üî mmHg) und die Formel $p = p_0 + \rho g h$ im Arbeitsheft.</div>
          <button class="btn-primary" onclick="unlockStep('step-exo-avance')">
            Bezugswerte gelesen ‚Üí Aufgaben freischalten
          </button>
        </div>

        <div class="lockable" data-step-lock="step-exo-avance">
          <div class="question-block active" data-question-step="step-exo-avance" data-question-index="0">
            <p class="question">
              1/2 ¬∑ Beim Tauchen (Meerwasser, $\rho \approx 1025\,\text{kg/m}^3$) in $18.0\,\text{m}$ Tiefe ‚Äì wie gro√ü ist der Gesamtdruck in bar ungef√§hr?
            </p>
            <div class="numeric-input-row">
              <input type="number" id="input-deepbar" step="0.1" placeholder="Druck in bar" />
              <button class="btn-primary" onclick="checkNumeric('deepbar')">
                Pr√ºfen
              </button>
            </div>
            <div id="feedback-deepbar" class="feedback"></div>
          </div>

          <div class="question-block" data-question-step="step-exo-avance" data-question-index="1">
            <p class="question">
              2/2 ¬∑ In einem S√º√üwasserbecken ($\rho \approx 1000\,\text{kg/m}^3$) betr√§gt der Gesamtdruck bei $12.0\,\text{m}$ Tiefe ungef√§hr wie viel in mmHg?
            </p>
            <div class="numeric-input-row">
              <input type="number" id="input-mmhgdepth" step="10" placeholder="Druck in mmHg" />
              <button class="btn-primary" onclick="checkNumeric('mmhgdepth')">
                Pr√ºfen
              </button>
            </div>

            <div id="feedback-mmhgdepth" class="feedback"></div>
          </div>
        </div>

        <div class="actions-row">
          <div class="actions-left">
            <button class="btn-secondary" onclick="goToStep('step-exo-hydro')">‚Üê Vorheriger Schritt</button>
          </div>
        <div class="actions-right">
            <button id="btn-to-expert" class="btn-primary hidden-soft" onclick="attemptAdvance('step-exo-expert','step-exo-avance')">
              N√§chster Schritt: Expertenaufgaben ‚Üí
            </button>
        </div>
      </div>
    </section>

    <!-- Schritt 6b: Remedial Fortgeschritten -->
    <section class="step" id="step-remediation-avance" data-index="6">
      <div class="step-tag">Schritt 6 bis ¬∑ Gezielte Hilfe</div>
      <h2 class="step-title">Einheiten und Tiefen vergleichen</h2>
      <div class="reading-box">
        <strong>N√ºtzliche Anhaltspunkte</strong><br />
        Meerwasser: $\rho \approx 1025\,\text{kg/m}^3$ ‚Üí $ \rho g h \approx 1.0 \times 10^4 h$ Pa.<br />
        1 bar ‚âà $10^5$ Pa, 1 bar ‚âà 760 mmHg. Denke daran: Tiefe ‚Üí $\rho g h$, dann ggf. in bar oder mmHg umrechnen.
      </div>
      <p class="step-instruction">
        Rechne zuerst in bar oder Pa, addiere $p_0$, und wandle bei Bedarf in mmHg um
        ($p\,\text{[Pa]} / 133.3$ ergibt mmHg).
      </p>
      <div class="actions-row">
        <div class="actions-left">
          <button class="btn-primary" onclick="goToStep('step-exo-avance')">Fortgeschrittene √úbungen erneut l√∂sen</button>
        </div>
      </div>
    </section>

    <!-- Schritt 7: Expertenaufgaben -->
    <section class="step" id="step-exo-expert" data-index="7">
      <div class="step-tag">Schritt 7 ¬∑ Expertenaufgaben</div>
      <h2 class="step-title">Vertiefe dein Verst√§ndnis</h2>

      <p class="step-instruction">
        Zwei anspruchsvollere Anwendungen. Arbeite sauber mit Einheiten und schreibe deine Zwischenschritte ins Heft.
      </p>

      <div class="question-block active" data-question-step="step-exo-expert" data-question-index="0">
        <p class="question">
          1/2 ¬∑ Ein Zylinder (Querschnitt $S = 0.020\,\text{m}^2$) ist mit √ñl gef√ºllt ($\rho = 850\,\text{kg/m}^3$), Volumen $V = 0.45\,\text{m}^3$. <br />
          Welche Druckerh√∂hung $\Delta p$ (in Pa) ergibt sich allein durch die √ñls√§ule (ohne $p_0$)?
        </p>
        <div class="numeric-input-row">
          <input type="number" id="input-expert1p" step="100" placeholder="Œîp in Pa" />
          <button class="btn-primary" onclick="checkNumeric('expert1p')">Pr√ºfen</button>
        </div>
        <div id="feedback-expert1" class="feedback"></div>
      </div>

      <div class="question-block" data-question-step="step-exo-expert" data-question-index="1">
        <p class="question">
          2/2 ¬∑ U-Rohr offen zur Luft: links Wasser (Dichte $1000\,\text{kg/m}^3$), rechts Quecksilber ($13600\,\text{kg/m}^3$). Die Wasseroberfl√§che links liegt $0.30\,\text{m}$ √ºber der Hg-Oberfl√§che rechts. <br />
          Welche H√∂he der Quecksilbers√§ule (in mm) stellt das Gleichgewicht her?
        </p>
        <div class="numeric-input-row">
          <input type="number" id="input-expert2" step="1" placeholder="H√∂he Hg in mm" />
          <button class="btn-primary" onclick="checkNumeric('expert2')">Pr√ºfen</button>
        </div>
        <div id="feedback-expert2" class="feedback"></div>
      </div>

      <div class="actions-row">
        <div class="actions-left">
          <button class="btn-secondary" onclick="goToStep('step-exo-avance')">‚Üê Vorheriger Schritt</button>
        </div>
        <div class="actions-right">
          <button id="btn-to-final" class="btn-primary hidden-soft" onclick="attemptAdvance('step-final','step-exo-expert')">N√§chster Schritt: Abschluss ‚Üí</button>
        </div>
      </div>
    </section>

    <!-- Schritt 7 bis: Remedial Experten -->
    <section class="step" id="step-remediation-expert" data-index="7">
      <div class="step-tag">Schritt 7 bis ¬∑ Gezielte Hilfe</div>
      <h2 class="step-title">Druck und Tiefe sauber verkn√ºpfen</h2>
      <div class="reading-box">
        <strong>Vorgehen</strong><br />
        1. Volumen zu H√∂he: $h = \dfrac{V}{S}$ (Zylinder). <br />
        2. Druckzuwachs: $\Delta p = \rho g h$. <br />
        3. Bei Fl√ºssigkeitss√§ulen in U-Rohren (offen): setze die Drucke gleich: $\rho_{\text{W}} g h_{\text{W}} = \rho_{\text{Hg}} g h_{\text{Hg}} \Rightarrow h_{\text{Hg}} = \dfrac{\rho_{\text{W}}}{\rho_{\text{Hg}}} h_{\text{W}}$.
        4. Arbeite in SI-Einheiten (Pa, kg/m¬≥, m/s¬≤, m) und wandle erst am Ende um.
      </div>
      <p class="step-instruction">
        Achte darauf, ob es um √úberdruck oder Gesamtdruck geht. Bei gemischten Fl√ºssigkeiten z√§hlen die Dichten auf jeder Seite separat (Hydrostatik-Balance).
      </p>
      <div class="actions-row">
        <div class="actions-left">
        <button class="btn-primary" onclick="goToStep('step-exo-expert')">Expertenaufgaben erneut l√∂sen</button>
        </div>
      </div>
    </section>

    <!-- Schritt 8: Abschluss -->
        <section class="step" id="step-final" data-index="8">
          <div class="step-tag">Schritt 8 ¬∑ Abschluss</div>
          <h2 class="step-title">Wo stehst du?</h2>

          <p class="step-instruction">
            Bevor du das Arbeitsheft weglegst: Pr√ºfe kurz, ob du die folgenden Punkte <strong>ohne nachzuschlagen</strong> kannst:
          </p>

          <ul class="side-list" style="margin-top: 6px; margin-bottom: 8px;">
            <li>Den Unterschied zwischen Kraft und Druck mit einem Beispiel erkl√§ren (Schuhe / Ski).</li>
            <li>Druck von bar in Pascal umrechnen und umgekehrt.</li>
            <li>Erkl√§ren, wof√ºr ¬´ $1\,\text{mmHg}$ ¬ª physikalisch steht.</li>
            <li>Die Formel $p = p_0 + \rho g h$ schreiben und erl√§utern.</li>
            <li>Den Druck in einer bestimmten Wassertiefe berechnen.</li>
          </ul>

          <div class="reading-box">
            <strong>Letzter Schritt</strong><br />
            Bevor du die √úbungen im <em>Arbeitsheft</em> machst, best√§tige hier deinen Fortschritt. <br />
            Danach erledige die Aufgaben im Heft ‚Äì dann z√§hlt deine Sequenz als 9/9. <br />
            Optional: G√∂nn dir eine kurze Meditation (Button unten).
          </div>

          <p class="step-instruction">
            Wenn etwas nicht sitzt, geh zum entsprechenden Schritt zur√ºck (Einheiten, Druck im Fl√ºssigkeit, Quecksilbers√§ule) und wiederhole die Fragen. Das ist das Prinzip des programmierten Lernens: kleine Schritte mit sofortigem Feedback.
          </p>

          <div class="actions-row">
            <div class="actions-left">
              <button class="btn-primary" onclick="completeFinalStep()">
                Fortschritt best√§tigen ‚Üí dann √úbungen im Heft
              </button>
            </div>
            <div class="actions-right">
              <button class="btn-secondary" onclick="goToStep('step-exo-expert')">‚Üê Zur√ºck zu den √úbungen</button>
              <button class="btn-meditation" onclick="openMeditation()">üßò Gef√ºhrte Meditation</button>
              <button class="btn-primary btn-compact" onclick="goToStep('step-intro')">Zum Start</button>
            </div>
          </div>
          <div class="hint" id="final-confirm-hint" style="margin-top: 6px;">
            Wenn alles passt: Du hast die Sequenz abgeschlossen.
          </div>
        </section>
      </div>
    </main>

    <!-- Seitenleiste: Memo / Hilfe -->
    <aside class="card collapsed-mobile" id="side-panel">
      <div class="side-section">
        <div class="side-card-title">Wesentliche Formeln</div>
        <div class="formula-box" style="margin-bottom: 10px;">
          <div class="math">$p = \dfrac{F}{A}$</div>
          <div class="explain">Druck als Kraft pro Fl√§che.</div>
        </div>
        <div class="formula-box" style="margin-bottom: 10px;">
          <div class="math">$p = p_0 + \rho g h$</div>
          <div class="explain">Gesamtdruck in einer Fl√ºssigkeit in Tiefe $h$.</div>
        </div>
        <div class="formula-box">
          <div class="math">
            $1\,\text{bar} = 10^5\,\text{Pa}$<br />
            $1\,\text{mmHg} \approx 133.3\,\text{Pa}$<br />
            $1\,\text{atm} \approx 1.013 \times 10^5\,\text{Pa} \approx 760\,\text{mmHg}$
          </div>
        </div>
      </div>

      <div class="side-section">
        <div class="side-card-title">Arbeitsstrategie</div>
        <ul class="side-list">
          <li>Lies immer den angegebenen Absatz im Arbeitsheft, bevor du antwortest.</li>
          <li>Notiere Formeln und Einheiten auf deinem Schmierblatt.</li>
          <li>Bei einem Fehler: R√ºckmeldung lesen und ggf. einen Schritt zur√ºckgehen.</li>
        </ul>
        <div class="side-note">
          Dieses Panel kannst du als kleines Memo w√§hrend der ganzen Sequenz nutzen.
        </div>
      </div>

      <div class="side-section">
        <div class="side-card-title">Fortschritt</div>
        <div class="score-box">
          <div class="score-value" id="score-display">0 / 9</div>
          <div class="score-label">
            Best√§tigte Schritte (mindestens einmal richtig geantwortet).
          </div>
        </div>
        <p class="side-note">
          Diese Zahl ist keine Note, sondern zeigt dir nur, was du bereits gefestigt hast.
        </p>
      </div>
    </aside>
  </div>

  <div id="reward-badge" aria-live="polite" aria-label="Belohnungsbild">
    <img id="reward-img" src="" alt="Niedliches Tier zur Ermutigung" />
    <div id="reward-message">Super! Weiter so üöÄ</div>
  </div>

  <div id="meditation-modal" role="dialog" aria-modal="true" aria-label="Meditation starten">
    <div class="meditation-card">
      <h3>üéß Kleine Pause?</h3>
      <p>Setz dir bitte die Kopfh√∂rer auf, atme einmal tief durch. Bist du bereit f√ºr die gef√ºhrte Meditation&nbsp;?</p>
      <div class="meditation-actions">
        <button class="btn-secondary btn-compact" onclick="closeMeditationModal()">Sp√§ter</button>
        <button class="btn-meditation" onclick="proceedMeditation()">Ja, lancer la vid√©o</button>
      </div>
    </div>
  </div>

  <div id="hint-panel" role="dialog" aria-live="polite" aria-label="Hinweis">
    <div class="hint-title">Hinweis</div>
    <div class="hint-body" id="hint-text"></div>
    <div class="hint-actions">
      <button class="btn-primary" onclick="acknowledgeHint()">Hint gelesen</button>
    </div>
  </div>

  <canvas id="confetti-canvas"></canvas>

  <script>
    const STORAGE_KEY = "pressionProgress_v1";
    const MEDITATION_URL = "https://www.yout-ube.com/watch?v=caQUSDezqLg";
    const stepsOrder = [
      "step-intro",
      "step-pretest",
      "step-unites",
      "step-hydrostatique",
      "step-torricelli",
      "step-exo-hydro",
      "step-exo-avance",
      "step-exo-expert",
      "step-final"
    ];

    const stepsNeedingReading = new Set([
      "step-pretest",
      "step-unites",
      "step-hydrostatique",
      "step-torricelli",
      "step-exo-hydro",
      "step-exo-avance"
    ]);

    const questionOrder = {
      "step-exo-hydro": ["3bar", "watercol"],
      "step-exo-avance": ["deepbar", "mmhgdepth"],
      "step-exo-expert": ["expert1p", "expert2"]
    };

    const mcqStepMap = {
      pretest: "step-pretest",
      unites1: "step-unites",
      unites2: "step-unites",
      hydro1: "step-hydrostatique"
    };

    const mcqOrder = {
      "step-unites": ["unites1", "unites2"]
    };

    const mcqHints = {
      // Hinweise nur genutzt, wenn keine gezielte Hilfe folgt (aktuelles Mapping: aucune)
    };

    const numericMeta = {
      hg: {
        inputId: "input-hg",
        feedbackId: "feedback-hg",
        stepId: "step-torricelli",
        remediationId: "step-remediation-hg",
        expected: 760,
        tolerance: 40,
        hintMethod: "Stelle h = p/(œÅg) um, rechne in Metern, dann in Millimetern."
      },
      "3bar": {
        inputId: "input-3bar",
        feedbackId: "feedback-3bar",
        stepId: "step-exo-hydro",
        remediationId: "step-remediation-exo",
        expected: 20,
        tolerance: 5,
        hintMethod: "Berechne √úberdruck: 3 bar - 1 bar. Teile (p - p0) durch œÅg ‚âà 10^4, Ergebnis in m."
      },
      watercol: {
        inputId: "input-watercol",
        feedbackId: "feedback-watercol",
        stepId: "step-exo-hydro",
        remediationId: "step-remediation-exo",
        expected: 10,
        tolerance: 2,
        hintMethod: "1 atm ‚âà 10^5 Pa. Teile durch œÅg (‚âà10^4) f√ºr Wasserh√∂he in m."
      },
      deepbar: {
        inputId: "input-deepbar",
        feedbackId: "feedback-deepbar",
        stepId: "step-exo-avance",
        remediationId: "step-remediation-avance",
        expected: 2.8,
        tolerance: 0.3,
        hintMethod: "Berechne œÅgh mit œÅ‚âà1025, h=18 m. Addiere p0‚âà1 bar, konvertiere in bar."
      },
      mmhgdepth: {
        inputId: "input-mmhgdepth",
        feedbackId: "feedback-mmhgdepth",
        stepId: "step-exo-avance",
        remediationId: "step-remediation-avance",
        expected: 1630,
        tolerance: 150,
        hintMethod: "Rechne p = p0 + œÅgh in Pa, dann teile durch 133.3, um mmHg zu erhalten."
      },
      expert1p: {
        inputId: "input-expert1p",
        feedbackId: "feedback-expert1",
        stepId: "step-exo-expert",
        remediationId: "step-remediation-expert",
        expected: 187000,
        tolerance: 20000,
        hintMethod: "Volumen zu H√∂he: $h = V/S$. Dann $\\Delta p = \\rho g h$ mit $\\rho=850$, $g\\approx 9.81$."
      },
      expert2: {
        inputId: "input-expert2",
        feedbackId: "feedback-expert2",
        stepId: "step-exo-expert",
        remediationId: "step-remediation-expert",
        expected: 22,
        tolerance: 3,
        hintMethod: "Gleichgewicht offen zur Luft: œÅ_Wasser g h_Wasser = œÅ_Hg g h_Hg. Also h_Hg = (œÅ_Wasser/œÅ_Hg)¬∑h_Wasser. Rechne in m, dann in mm."
      }
    };

    const rewardImages = [
      "images/image1.avif",
      "images/image2.jpg",
      "images/image3.jpg",
      "images/image4.avif",
      "images/image5.jpg",
      "images/image6.jpg",
      "images/image7.webp"
    ];

    let rewardTimeout = null;

    const defaultQuestionState = () => ({
      "step-exo-hydro": 1,
      "step-exo-avance": 1,
      "step-exo-expert": 1
    });
    const defaultMcqState = () => ({
      "step-unites": 1
    });

    let validatedSteps = new Set();
    let readingUnlocked = {};
    let currentStepId = "step-intro";
    let questionState = defaultQuestionState();
    let mcqState = defaultMcqState();
    let hintVisible = false;
    let confettiRunning = false;

    function updateChromeVisibility() {
      const subtitle = document.getElementById("subtitle-text");
      const capsules = document.getElementById("capsules-row");
      const resetBtn = document.getElementById("reset-btn");
      const isIntro = currentStepId === "step-intro";
      const isFinal = currentStepId === "step-final";
      const shouldHideHeader = !isIntro;
      if (subtitle) subtitle.classList.toggle("hidden-soft", shouldHideHeader);
      if (capsules) capsules.classList.toggle("hidden-soft", shouldHideHeader);
      if (resetBtn) resetBtn.classList.toggle("hidden-soft", !isIntro);
    }

    function openMeditation() {
      const modal = document.getElementById("meditation-modal");
      if (modal) {
        modal.classList.add("visible");
      } else {
        window.open(MEDITATION_URL, "_blank", "noopener");
      }
    }

    function closeMeditationModal() {
      const modal = document.getElementById("meditation-modal");
      if (modal) {
        modal.classList.remove("visible");
      }
    }

    function proceedMeditation() {
      closeMeditationModal();
      window.open(MEDITATION_URL, "_blank", "noopener");
    }

    // Confetti simple
    function startConfetti(duration = 2500) {
      if (confettiRunning) return;
      const canvas = document.getElementById("confetti-canvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      canvas.style.display = "block";
      const W = (canvas.width = window.innerWidth);
      const H = (canvas.height = window.innerHeight);
      const pieces = Array.from({ length: 320 }, () => ({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: Math.random() * 6 + 4,
        d: Math.random() * 2 + 0.5,
        color: `hsl(${Math.random() * 360}, 80%, 60%)`,
        tilt: Math.random() * 10 - 10,
        vy: Math.random() * 3.5 + 1.5
      }));
      let angle = 0;
      confettiRunning = true;

      function draw() {
        ctx.clearRect(0, 0, W, H);
        angle += 0.01;
        pieces.forEach((p) => {
          p.y += p.vy + (Math.cos(angle + p.d) + 1) * 0.6;
          p.x += Math.sin(angle) * (0.8 + p.d * 0.1);
          if (p.y > H) {
            p.y = H + 20; // laissez tomber hors de l'√©cran
          }
          if (p.y > H + 40) {
            // stop repositioning, let it disappear
            return;
          }
          ctx.beginPath();
          ctx.fillStyle = p.color;
          ctx.fillRect(p.x, p.y, p.r, p.r);
        });
        if (confettiRunning) {
          requestAnimationFrame(draw);
        }
      }
      draw();
      setTimeout(() => {
        confettiRunning = false;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.width = 1;
        canvas.height = 1;
        canvas.style.display = "none";
      }, duration);
    }

    function showHint(text) {
      const panel = document.getElementById("hint-panel");
      const body = document.getElementById("hint-text");
      if (!panel || !body) return;
      body.textContent = text;
      panel.classList.add("visible");
      hintVisible = true;
    }

    function applyReadingVisibility() {
      Object.keys(readingUnlocked).forEach((stepId) => {
        if (readingUnlocked[stepId]) {
          hideReading(stepId);
        }
      });
    }

    const nextButtonsConfig = {
      "btn-to-hydro": "step-unites",
      "btn-to-torricelli": "step-hydrostatique",
      "btn-to-exo-hydro": "step-torricelli",
      "btn-to-avance": "step-exo-hydro",
      "btn-to-expert": "step-exo-avance",
      "btn-to-final": "step-exo-expert"
    };

    function updateNextButtons() {
      Object.entries(nextButtonsConfig).forEach(([btnId, requiredStep]) => {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        const unlocked = validatedSteps.has(requiredStep);
        btn.classList.toggle("hidden-soft", !unlocked);
      });
    }

    function hideReading(stepId) {
      const step = document.getElementById(stepId);
      if (!step) return;
      const box = step.querySelector(".reading-box");
      if (!box) return;
      box.classList.add("reading-hidden");
      let toggle = step.querySelector(`.reading-toggle[data-step='${stepId}']`);
      if (!toggle) {
        toggle = document.createElement("button");
        toggle.className = "btn-secondary btn-compact reading-toggle";
        toggle.dataset.step = stepId;
        toggle.textContent = "Text erneut anzeigen";
        toggle.onclick = () => showReading(stepId);
        box.insertAdjacentElement("afterend", toggle);
      }
    }

    function showReading(stepId) {
      const step = document.getElementById(stepId);
      if (!step) return;
      const box = step.querySelector(".reading-box");
      if (!box) return;
      box.classList.remove("reading-hidden");
      const toggle = step.querySelector(`.reading-toggle[data-step='${stepId}']`);
      if (toggle) toggle.textContent = "Text ausblenden";
      // Hide again after a slight delay if toggle clicked again
      if (toggle) {
        toggle.onclick = () => hideReading(stepId);
      }
    }

    function acknowledgeHint() {
      const panel = document.getElementById("hint-panel");
      if (panel) {
        panel.classList.remove("visible");
      }
      hintVisible = false;
    }

    function resetProgress() {
      localStorage.removeItem(STORAGE_KEY);
      validatedSteps = new Set();
      readingUnlocked = {};
      questionState = defaultQuestionState();
      currentStepId = "step-intro";
      document.querySelectorAll(".step").forEach((s) => s.classList.remove("active"));
      const intro = document.getElementById("step-intro");
      if (intro) intro.classList.add("active");
      applyLockStates();
      updateQuestionVisibility();
      applyReadingVisibility();
      updateChromeVisibility();
      updateProgress();
      refreshMobileToggleLabels();
      acknowledgeHint();
    }

    function normalizeQuestionState() {
      Object.keys(questionOrder).forEach((stepId) => {
        const val = questionState[stepId];
        if (!Number.isInteger(val) || val < 1) {
          questionState[stepId] = 1;
        }
        const max = questionOrder[stepId].length;
        if (questionState[stepId] > max) {
          questionState[stepId] = max;
        }
      });
    }

    function normalizeMcqState() {
      Object.keys(mcqOrder).forEach((stepId) => {
        const val = mcqState[stepId];
        if (!Number.isInteger(val) || val < 1) {
          mcqState[stepId] = 1;
        }
        const max = mcqOrder[stepId].length;
        if (mcqState[stepId] > max) {
          mcqState[stepId] = max;
        }
      });
    }

    function showReward(message = "Super! Weiter so üöÄ") {
      const badge = document.getElementById("reward-badge");
      const img = document.getElementById("reward-img");
      const msg = document.getElementById("reward-message");
      if (!badge || !img || !msg || rewardImages.length === 0) return;
      const pick = rewardImages[Math.floor(Math.random() * rewardImages.length)];
      img.src = pick;
      msg.textContent = message;
      badge.classList.add("visible");
      if (rewardTimeout) {
        clearTimeout(rewardTimeout);
      }
      rewardTimeout = setTimeout(() => {
        badge.classList.remove("visible");
      }, 1800);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed.validatedSteps)) {
          const filtered = parsed.validatedSteps.filter((id) =>
            stepsOrder.includes(id)
          );
          validatedSteps = new Set(filtered);
        }
        readingUnlocked = parsed.readingUnlocked || {};
        questionState = parsed.questionState || questionState;
        mcqState = parsed.mcqState || mcqState;
        currentStepId = parsed.currentStepId || currentStepId;
      } catch (e) {
        console.warn("Fortschritt konnte nicht geladen werden, wir starten neu.");
      }
    }

    function persistState() {
      try {
        const payload = {
          validatedSteps: Array.from(validatedSteps),
          readingUnlocked,
          currentStepId,
          questionState,
          mcqState
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {
        console.warn("Fortschritt konnte nicht gespeichert werden.", e);
      }
    }

    function isStepUnlocked(stepId) {
      return !stepsNeedingReading.has(stepId) || !!readingUnlocked[stepId];
    }

    function applyLockStates() {
      document.querySelectorAll("[data-step-lock]").forEach((el) => {
        const stepId = el.getAttribute("data-step-lock");
        const unlocked = isStepUnlocked(stepId);
        el.classList.toggle("locked", !unlocked);
      });

      document.querySelectorAll(".reading-guard").forEach((guard) => {
        const stepId = guard.getAttribute("data-step-guard");
        const unlocked = isStepUnlocked(stepId);
        guard.classList.toggle("done", unlocked);
        const btn = guard.querySelector("button");
        if (btn) {
          btn.disabled = unlocked;
          btn.textContent = unlocked
            ? "Lekt√ºre best√§tigt"
            : btn.getAttribute("data-default-label") ||
              btn.textContent ||
              "Lekt√ºre best√§tigen";
        }
      });
    }

    function updateQuestionVisibility() {
      normalizeQuestionState(); normalizeMcqState();
      document.querySelectorAll("[data-question-step]").forEach((block) => {
        const stepId = block.getAttribute("data-question-step");
        const idx = parseInt(block.getAttribute("data-question-index"), 10) || 0;
        const current = (questionState[stepId] || 1) - 1;
        block.classList.toggle("active", idx === current);
      });
    }

    function updateMCQVisibility() {
      document.querySelectorAll("[data-mcq-step]").forEach((block) => {
        const stepId = block.getAttribute("data-mcq-step");
        const idx = parseInt(block.getAttribute("data-mcq-index"), 10) || 0;
        const current = (mcqState[stepId] || 1) - 1;
        block.classList.toggle("active", idx === current);
      });
    }

    function unlockStep(stepId) {
      readingUnlocked[stepId] = true;
      hideReading(stepId);
      applyLockStates();
      persistState();
    }

    function updateProgress(save = true) {
      const total = stepsOrder.length;
      const done = validatedSteps.size;
      const percent = (done / total) * 100;

      document.getElementById("progress-bar").style.width = percent + "%";
      document.getElementById("progress-text").textContent =
        done + " / " + total + " Schritte best√§tigt";
      document.getElementById("score-display").textContent =
        done + " / " + total;
      updateNextButtons();
      if (save) {
        persistState();
      }
    }

    function refreshMobileToggleLabels() {
      document.querySelectorAll(".mobile-toggle").forEach((btn) => {
        const targetId =
          btn.textContent.includes("Infos") ? "header-info" : "side-panel";
        const target = document.getElementById(targetId);
        if (!target) return;
        const isCollapsed = target.classList.contains("collapsed-mobile");
        if (btn.textContent.includes("Infos")) {
          btn.textContent = isCollapsed ? "Infos anzeigen" : "Infos ausblenden";
        } else {
          btn.textContent = isCollapsed
            ? "Formeln/Memo anzeigen"
            : "Formeln/Memo ausblenden";
        }
      });
    }

    function toggleMobileSection(id, button, showLabel, hideLabel) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("collapsed-mobile");
      if (button && showLabel && hideLabel) {
        const isCollapsed = el.classList.contains("collapsed-mobile");
        button.textContent = isCollapsed ? showLabel : hideLabel;
      }
    }

    function goToStep(id, options = {}) {
      document.querySelectorAll(".step").forEach((s) => s.classList.remove("active"));
      let finalId = id;
      const target = document.getElementById(id);
      if (!target) {
        finalId = "step-intro";
      }
      const targetElement = document.getElementById(finalId);
      if (targetElement) {
        targetElement.classList.add("active");
      }
      if (currentStepId === "step-intro" && finalId !== "step-intro") {
        
      }
      // Finale automatisch validieren
      if (finalId === "step-final") {
        validatedSteps.add("step-final"); validatedSteps.add("step-exo-expert");
      }
      currentStepId = finalId;
      applyLockStates();
      updateQuestionVisibility();
      applyReadingVisibility();
      updateMCQVisibility();
      updateChromeVisibility();
      updateNextButtons();
      updateProgress(!options.skipSave);
    }

    function attemptAdvance(targetStep, requiredStep) {
      if (requiredStep && !validatedSteps.has(requiredStep)) {
        alert("Bevor du weitergehst, best√§tige die Fragen dieses Schritts.");
        return;
      }
      goToStep(targetStep);
    }

    function handleMCQ(button, group, isCorrect) {
      const stepId = mcqStepMap[group];
      const feedbackId =
        group === "pretest" ? "feedback-pretest"
        : group === "unites1" || group === "unites2" ? "feedback-unites"
        : group === "hydro1" ? "feedback-hydro"
        : "";
      const order = stepId ? mcqOrder[stepId] : null;
      const idxInOrder = order ? order.indexOf(group) : -1;

      if (stepId && !isStepUnlocked(stepId)) {
        if (feedbackId) {
          const fbLocked = document.getElementById(feedbackId);
          if (fbLocked) {
            fbLocked.textContent =
              "Bitte zuerst die angegebene Stelle lesen und die Lekt√ºre best√§tigen.";
            fbLocked.classList.add("ko");
            fbLocked.classList.remove("ok");
          }
        }
        return;
      }

      const container = button.parentElement;

      if (container) {
        container.querySelectorAll(".option-btn").forEach((btn) => {
          btn.classList.remove("correct", "incorrect");
        });
      }

      if (isCorrect) {
        button.classList.add("correct");
        if (feedbackId) {
          const fb = document.getElementById(feedbackId);
          fb.textContent = "‚úî Richtig, du kannst zum n√§chsten Schritt gehen.";
          fb.classList.add("ok");
          fb.classList.remove("ko");
        }

        if (group === "pretest") {
          validatedSteps.add("step-pretest");
          goToStep("step-unites");
        } else if (group === "hydro1") {
          validatedSteps.add("step-hydrostatique");
        } else if (order && idxInOrder !== -1) {
          const nextIndex = idxInOrder + 1;
          if (nextIndex >= order.length) {
            validatedSteps.add(stepId);
            mcqState[stepId] = order.length;
          } else {
            mcqState[stepId] = nextIndex + 1;
            if (feedbackId) {
              const fb = document.getElementById(feedbackId);
              fb.textContent = "‚úî Richtig, n√§chste Frage wird freigeschaltet.";
            }
          }
          updateMCQVisibility();
        }
        showReward();
      } else {
        button.classList.add("incorrect");
        if (feedbackId) {
          const fb = document.getElementById(feedbackId);
          fb.classList.remove("ok");
          fb.classList.add("ko");
          fb.textContent = "‚úñ Versuche erneut nach Lekt√ºre der Hilfe.";
          if (group === "pretest") {
            setTimeout(() => goToStep("step-remediation-pression"), 900);
          } else if (group === "unites1" || group === "unites2") {
            setTimeout(() => goToStep("step-remediation-unites"), 900);
          } else if (group === "hydro1") {
            setTimeout(() => goToStep("step-remediation-hydro"), 900);
          }
        }
      }
      updateProgress();
    }

    function checkNumeric(kind) {
      const meta = numericMeta[kind];
      if (!meta) return;

      const { inputId, feedbackId, stepId, remediationId, expected, tolerance, hintMethod } = meta;

      if (!isStepUnlocked(stepId)) {
        const fbLocked = document.getElementById(feedbackId);
        if (fbLocked) {
          fbLocked.textContent =
            "Bitte zuerst die angegebene Lekt√ºre best√§tigen, um diese Aufgaben freizuschalten.";
          fbLocked.classList.add("ko");
          fbLocked.classList.remove("ok");
        }
        return;
      }

      const inputEl = document.getElementById(inputId);
      const fb = document.getElementById(feedbackId);
      if (!inputEl || !fb) return;

      const value = parseFloat(inputEl.value);
      if (isNaN(value)) {
        fb.textContent = "Gib bitte eine Zahl ein.";
        fb.classList.add("ko");
        fb.classList.remove("ok");
        return;
      }

      const diff = Math.abs(value - expected);
      const order = questionOrder[stepId];
      const idx = order ? order.indexOf(kind) : -1;

      if (diff <= tolerance) {
        fb.textContent = "‚úî Plausibles Ergebnis (Toleranz ¬±" + tolerance + ").";
        fb.classList.add("ok");
        fb.classList.remove("ko");

        if (order && idx !== -1) {
          const nextIndex = idx + 1;
          if (nextIndex < order.length) {
            questionState[stepId] = nextIndex + 1;
            fb.textContent += " N√§chste Aufgabe freigeschaltet.";
          } else {
            questionState[stepId] = order.length;
            validatedSteps.add(stepId);
            if (stepId === "step-exo-hydro") {
              fb.textContent += " Du wechselst nun zur schwereren Aufgabe.";
              setTimeout(() => goToStep("step-exo-avance"), 900);
            } else if (stepId === "step-exo-avance") {
              fb.textContent += " Gut geschafft ‚Äì weiter zu den Expertenaufgaben.";
              setTimeout(() => goToStep("step-exo-expert"), 900);
            } else if (stepId === "step-exo-expert") {
              fb.textContent += " Gut geschafft ‚Äì weiter zum Abschluss.";
              setTimeout(() => goToStep("step-final"), 900);
            }
          }
          updateQuestionVisibility();
        } else {
          validatedSteps.add(stepId);
        }
        showReward();
      } else {
        fb.textContent =
          "‚úñ Ergebnis weit entfernt. Sieh dir die gezielte Hilfe an und versuche erneut.";
        fb.classList.add("ko");
        fb.classList.remove("ok");
        if (hintMethod && !remediationId) {
          showHint(hintMethod);
        }
        if (remediationId) {
          setTimeout(() => goToStep(remediationId), 900);
        }
      }
      updateProgress();
      persistState();
    }

    function completeFinalStep() {
      validatedSteps.add("step-final"); validatedSteps.add("step-exo-expert");
      const hint = document.getElementById("final-confirm-hint");
      if (hint) {
        hint.textContent = "‚úî Schritt best√§tigt ‚Äì du hast 9/9 erreicht.";
      }
      showReward("Starke Arbeit! Jetzt ab ins Heft.");
      startConfetti();
      updateProgress();
    }

    function initializeApp() {
      loadState();
      
      normalizeQuestionState(); normalizeMcqState();
      if (!document.getElementById(currentStepId)) {
        currentStepId = "step-intro";
      }
      document.querySelectorAll(".step").forEach((s) => s.classList.remove("active"));
      const start = document.getElementById(currentStepId) ? currentStepId : "step-intro";
      document.getElementById(start).classList.add("active");
      applyLockStates();
      updateQuestionVisibility();
      updateMCQVisibility();
      applyReadingVisibility();
      updateProgress();
      refreshMobileToggleLabels();
      updateChromeVisibility();
      updateNextButtons();
    }

    initializeApp();
  </script>
</body>
</html>
